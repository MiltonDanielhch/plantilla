---
import DashboardLayout from '../../../components/layout/dashboard-layout.astro';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '../../../components/ui';
import Button from '../../../components/ui/button.astro';
import { api } from '../../../lib/api';
import type { User } from '../../../types';

export const prerender = false;

const { id } = Astro.params;
const userId = parseInt(id || '0');

let user: User | null = null;
let error = null;

try {
    const token = Astro.cookies.get("session")?.value || Astro.cookies.get("token")?.value;
    if (!token) throw new Error("No token found");
    
    // Obtener datos del usuario
    user = await api.getUser(userId, token);
} catch (e: any) {
    console.error("Error fetching user:", e);
    error = e.message || "Usuario no encontrado";
}

if (error) {
    return Astro.redirect('/dashboard/users');
}
---

<DashboardLayout 
  title="Editar Usuario" 
  description={`Editando usuario #${userId}`}
  currentPath="/dashboard/users/"
>
    <div class="max-w-2xl mx-auto">
        <div class="mb-6">
            <a href="/dashboard/users/" class="text-sm text-muted-foreground hover:text-primary flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                Volver a la lista
            </a>
        </div>

        <Card>
            <CardHeader>
                <CardTitle>Detalles del Usuario</CardTitle>
                <CardDescription>
                    Actualiza la información del usuario.
                </CardDescription>
            </CardHeader>
            <CardContent>
                {user && (
                    <form id="edit-user-form" class="space-y-4" data-id={user.id}>
                        <div class="grid gap-4 md:grid-cols-2">
                            <div class="space-y-2">
                                <label class="text-sm font-medium">ID</label>
                                <input 
                                    type="text" 
                                    value={user.id} 
                                    disabled 
                                    class="h-10 w-full rounded-md border border-input bg-muted px-3 text-sm opacity-50"
                                />
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-medium">Rol</label>
                                <input 
                                    type="text" 
                                    value={user.role} 
                                    disabled 
                                    class="h-10 w-full rounded-md border border-input bg-muted px-3 text-sm opacity-50"
                                />
                                <p class="text-xs text-muted-foreground">El rol no se puede editar aquí.</p>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label class="text-sm font-medium">Nombre de Usuario</label>
                            <input 
                                type="text" 
                                value={user.username} 
                                disabled
                                class="h-10 w-full rounded-md border border-input bg-muted px-3 text-sm opacity-50"
                            />
                        </div>

                        <div class="space-y-2">
                            <label for="email" class="text-sm font-medium">Email</label>
                            <input 
                                type="email" 
                                id="email" 
                                name="email" 
                                value={user.email || ''} 
                                placeholder="usuario@ejemplo.com"
                                class="h-10 w-full rounded-md border border-input bg-background px-3 text-sm"
                            />
                        </div>

                        <div class="flex justify-end pt-4">
                            <Button type="submit" id="save-btn">Guardar Cambios</Button>
                        </div>
                    </form>
                )}
            </CardContent>
        </Card>
    </div>
</DashboardLayout>

<script>
    import { api } from '../../../lib/api';
    import { addToast } from '../../../stores/toast';

    const form = document.getElementById('edit-user-form') as HTMLFormElement;
    const saveBtn = document.getElementById('save-btn') as HTMLButtonElement;

    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = parseInt(form.dataset.id || '0');
            const email = (document.getElementById('email') as HTMLInputElement).value;

            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';

            try {
                await api.updateUser(userId, { email });
                addToast({ type: 'success', message: 'Usuario actualizado correctamente' });

                setTimeout(() => {
                    window.location.href = '/dashboard/users';
                }, 1500);
            } catch (error: any) {
                addToast({ type: 'error', message: error.message || 'Error al actualizar' });
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Guardar Cambios';
            }
        });
    }
</script>