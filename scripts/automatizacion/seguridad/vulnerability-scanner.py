#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
VULNERABILITY-SCANNER - EscÃ¡ner de Vulnerabilidades
Revisa las librerÃ­as del proyecto contra bases de datos de vulnerabilidades conocidas.
Trigger: Antes de deploy o manual
"""

import sys
import io

sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding="utf-8")

import os
import json
import subprocess
import sys
from pathlib import Path
from datetime import datetime

OUTPUT_FILE = Path("logs/vulnerability_report.md")


def check_npm_vulnerabilities():
    print("[INFO] Escaneando Node.js...")
    vulnerabilities = []

    try:
        result = subprocess.run(
            ["npm", "audit", "--json"], capture_output=True, text=True, timeout=60
        )

        data = json.loads(result.stdout)

        if "vulnerabilities" in data:
            vulns = data["vulnerabilities"]

            for name, info in vulns.items():
                vulnerabilities.append(
                    {
                        "package": name,
                        "severity": info.get("severity", "unknown"),
                        "via": str(info.get("via", ""))[:100],
                    }
                )

    except json.JSONDecodeError:
        print("   [WARN] No se pudo parsear output de npm")
    except Exception as e:
        print(f"   [ERROR] {e}")

    return vulnerabilities


def check_python_vulnerabilities():
    print("[INFO] Escaneando Python...")
    vulnerabilities = []

    try:
        result = subprocess.run(
            ["pip", "list", "--format=json"], capture_output=True, text=True, timeout=30
        )

        packages = json.loads(result.stdout)

        for pkg in packages:
            print(f"   Checking {pkg['name']}...")

            try:
                result = subprocess.run(
                    ["pip", "audit", "--json"],
                    capture_output=True,
                    text=True,
                    timeout=10,
                )

                if result.stdout:
                    data = json.loads(result.stdout)

                    if "vulnerabilities" in data:
                        for vuln in data["vulnerabilities"]:
                            if vuln["name"].lower() == pkg["name"].lower():
                                vulnerabilities.append(
                                    {
                                        "package": pkg["name"],
                                        "version": pkg["version"],
                                        "severity": vuln.get("severity", "unknown"),
                                        "id": vuln.get("id", "N/A"),
                                    }
                                )
            except:
                pass

    except Exception as e:
        print(f"   [WARN] {e}")

    return vulnerabilities


def check_rust_vulnerabilities():
    print("[INFO] Escaneando Rust...")
    vulnerabilities = []

    try:
        result = subprocess.run(
            ["cargo", "audit", "--json"], capture_output=True, text=True, timeout=60
        )

        for line in result.stdout.split("\n"):
            if line.strip():
                try:
                    data = json.loads(line)
                    if data.get("type") == "vulnerability":
                        vulnerabilities.append(
                            {
                                "package": data.get("package", "unknown"),
                                "severity": data.get("advisory", {}).get(
                                    "severity", "unknown"
                                ),
                                "id": data.get("id", "N/A"),
                            }
                        )
                except:
                    pass
    except FileNotFoundError:
        print("   [WARN] cargo-audit no instalado")
    except Exception as e:
        print(f"   [ERROR] {e}")

    return vulnerabilities


def generate_report(all_vulns):
    severity_colors = {
        "critical": "ðŸ”´",
        "high": "ðŸŸ ",
        "medium": "ðŸŸ¡",
        "low": "ðŸŸ¢",
        "unknown": "âšª",
    }

    md = f"""# Reporte de Vulnerabilidades - SintonÃ­a 3026

**Fecha:** {datetime.now().strftime("%Y-%m-%d %H:%M")}

## Resumen

| Severidad | Cantidad |
|-----------|----------|
"""

    counts = {}
    for v in all_vulns:
        sev = v.get("severity", "unknown")
        counts[sev] = counts.get(sev, 0) + 1

    for sev, count in counts.items():
        icon = severity_colors.get(sev.lower(), "âšª")
        md += f"| {icon} {sev.title()} | {count} |\n"

    md += f"\n**Total:** {len(all_vulns)} vulnerabilidades\n\n"

    if all_vulns:
        md += "## Detalles\n\n"

        for v in all_vulns:
            icon = severity_colors.get(v.get("severity", "unknown").lower(), "âšª")
            md += f"### {icon} {v.get('package', 'unknown')}\n"
            md += f"- VersiÃ³n: {v.get('version', 'N/A')}\n"
            md += f"- Severidad: {v.get('severity', 'unknown')}\n"
            md += f"- ID: {v.get('id', 'N/A')}\n"
            md += f"- Info: {v.get('via', v.get('id', 'N/A'))}\n\n"

        md += "## Recomendaciones\n\n"
        md += "1. Actualiza los paquetes vulnerables a las Ãºltimas versiones\n"
        md += "2. Si no hay actualizaciÃ³n, considera alternativas mÃ¡s seguras\n"
        md += "3. Ejecuta `npm audit fix` o `pip audit` para automÃ¡tico\n"
    else:
        md += "\nâœ… **Â¡No se detectaron vulnerabilidades!**\n"

    with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
        f.write(md)

    return md


def main():
    print("[VULNERABILITY-SCANNER] EscÃ¡ner de Vulnerabilidades")
    print("=" * 50)

    all_vulnerabilities = []

    if Path("package.json").exists():
        all_vulnerabilities.extend(check_npm_vulnerabilities())

    if Path("requirements.txt").exists() or Path("pyproject.toml").exists():
        all_vulnerabilities.extend(check_python_vulnerabilities())

    if Path("Cargo.toml").exists():
        all_vulnerabilities.extend(check_rust_vulnerabilities())

    print("\n" + "=" * 50)

    if all_vulnerabilities:
        print(f"[ALERT] {len(all_vulnerabilities)} vulnerabilidad(es) encontrada(s)!")
    else:
        print("[OK] No se detectaron vulnerabilidades")

    report = generate_report(all_vulnerabilities)

    print(f"\n[OK] Reporte guardado: {OUTPUT_FILE}")

    return 1 if all_vulnerabilities else 0


if __name__ == "__main__":
    sys.exit(main())
