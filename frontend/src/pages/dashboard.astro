---
import Layout from '../layouts/Layout.astro';
import LogoutButton from '../components/LogoutButton.astro';
import UserList from '../components/UserList.astro';
import AuditTable from '../components/AuditTable.astro';
---

<Layout title="Panel de Control - Sinton√≠a 3026">
    <main style="max-width: 800px; margin: 2rem auto; padding: 2rem;">
        <!-- Estado de Carga -->
        <div id="loading" style="text-align: center; color: #9ca3af; margin-top: 4rem;">
            <p>Verificando credenciales de acceso...</p>
        </div>

        <!-- Contenido Protegido (Oculto por defecto) -->
        <div id="dashboard-content" style="display: none;">
            <h1 style="color: #10b981; margin-bottom: 1rem; border-bottom: 1px solid #374151; padding-bottom: 1rem;">
                üéõÔ∏è Panel de Control
            </h1>
            
            <div style="background: #1f2937; padding: 2rem; border-radius: 8px; border: 1px solid #374151; margin-bottom: 2rem;">
                <h3 style="color: #60a5fa; margin-bottom: 0.5rem;">Mensaje del N√∫cleo:</h3>
                <p id="secret-message" style="color: #e5e7eb; font-size: 1.2rem; font-family: monospace;">
                    Conectando con la Sinton√≠a...
                </p>
            </div>

            <!-- Controles de Administrador (Invisibles por defecto) -->
            <div id="admin-controls" style="display: none; background: #374151; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; border-left: 4px solid #ef4444;">
                <h3 style="color: #ef4444; margin-top: 0;">üõ°Ô∏è Zona de Administraci√≥n</h3>
                <p style="font-size: 0.9rem; color: #d1d5db;">Tienes permisos ejecutivos sobre la plataforma.</p>
                
                <!-- Navegaci√≥n de Pesta√±as -->
                <div style="margin-top: 1rem; margin-bottom: 1rem; border-bottom: 1px solid #4b5563; display: flex; gap: 1rem;">
                    <button id="tab-users" class="admin-tab" style="background: none; border: none; color: #e5e7eb; padding: 0.5rem 1rem; cursor: pointer; border-bottom: 2px solid #10b981; font-weight: bold;">Usuarios</button>
                    <button id="tab-audit" class="admin-tab" style="background: none; border: none; color: #9ca3af; padding: 0.5rem 1rem; cursor: pointer; border-bottom: 2px solid transparent;">Auditor√≠a</button>
                </div>

                <!-- Vistas -->
                <div id="view-users">
                    <UserList isAdmin={true} />
                </div>
                <div id="view-audit" style="display: none;">
                    <AuditTable />
                </div>
            </div>

            <LogoutButton />
        </div>
    </main>
</Layout>

<script>
    import { API_BASE_URL } from '../config';
    const content = document.getElementById('dashboard-content');
    const loading = document.getElementById('loading');
    const secretMessage = document.getElementById('secret-message');
    const adminControls = document.getElementById('admin-controls');
    const tabUsers = document.getElementById('tab-users');
    const tabAudit = document.getElementById('tab-audit');
    const viewUsers = document.getElementById('view-users');
    const viewAudit = document.getElementById('view-audit');

    async function initDashboard() {
        try {
            // Intentamos obtener el secreto enviando la cookie (credentials: include)
            const response = await fetch(`${API_BASE_URL}/dashboard`, {
                method: 'GET',
                credentials: 'include' 
            });

            if (response.ok) {
                // ‚úÖ Autorizado: Mostramos el contenido
                const data = await response.json();
                
                if (secretMessage) secretMessage.textContent = data.message;
                
                // L√≥gica de Roles
                if (data.role === 'Admin' && adminControls) {
                    adminControls.style.display = 'block';
                    // Aqu√≠ podr√≠amos disparar la carga de la lista de usuarios
                }

                if (content) content.style.display = 'block';
                if (loading) loading.style.display = 'none';
            } else {
                // ‚õî No Autorizado: Al login
                window.location.href = '/login/';
            }
        } catch (error) {
            console.error('Error:', error);
            if (loading) loading.innerHTML = '<p style="color: #ef4444;">‚ö†Ô∏è Error de conexi√≥n con el servidor.</p>';
        }
    }

    // Ejecutar al cargar
    initDashboard();

    // L√≥gica de Pesta√±as
    function switchTab(tab: string) {
        if (tab === 'users') {
            if(viewUsers) viewUsers.style.display = 'block';
            if(viewAudit) viewAudit.style.display = 'none';
            if(tabUsers) { tabUsers.style.borderBottom = '2px solid #10b981'; tabUsers.style.color = '#e5e7eb'; }
            if(tabAudit) { tabAudit.style.borderBottom = '2px solid transparent'; tabAudit.style.color = '#9ca3af'; }
        } else {
            if(viewUsers) viewUsers.style.display = 'none';
            if(viewAudit) viewAudit.style.display = 'block';
            if(tabAudit) { tabAudit.style.borderBottom = '2px solid #60a5fa'; tabAudit.style.color = '#e5e7eb'; }
            if(tabUsers) { tabUsers.style.borderBottom = '2px solid transparent'; tabUsers.style.color = '#9ca3af'; }
        }
    }

    if(tabUsers) tabUsers.addEventListener('click', () => switchTab('users'));
    if(tabAudit) tabAudit.addEventListener('click', () => switchTab('audit'));

</script>