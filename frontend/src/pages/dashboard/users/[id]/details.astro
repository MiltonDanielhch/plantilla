---
import DashboardLayout from '../../../../components/layout/dashboard-layout.astro';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '../../../../components/ui';
import { api } from '../../../../lib/api';
import { formatDate } from '../../../../lib/utils';
import type { User } from '../../../../types';

export const prerender = false;

const { id } = Astro.params;
const userId = parseInt(id || '0');

let user: User | null = null;
let error = null;

try {
    const token = Astro.cookies.get("auth_token")?.value || Astro.cookies.get("session")?.value;
    if (!token) throw new Error("No token found");
    
    user = await api.getUser(userId, token);
} catch (e: any) {
    console.error("Error fetching user:", e);
    error = e.message || "Usuario no encontrado";
}

if (error || !user) {
    return Astro.redirect('/dashboard/users');
}
---

<DashboardLayout 
  title="Detalles del Usuario" 
  description={`Visualizando usuario #${userId}`}
  currentPath="/dashboard/users/"
>
    <div class="max-w-2xl mx-auto">
        <div class="mb-6">
            <a href="/dashboard/users/" class="text-sm text-muted-foreground hover:text-primary flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                Volver a la lista
            </a>
        </div>

        <Card>
            <CardHeader>
                <div class="flex items-center justify-between">
                    <div>
                        <CardTitle>Informaci√≥n del Usuario</CardTitle>
                        <CardDescription>Vista de lectura de los datos del usuario.</CardDescription>
                    </div>
                    <a href={`/dashboard/users/${userId}`} class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 py-2">
                        Editar
                    </a>
                </div>
            </CardHeader>
            <CardContent class="space-y-6">
                <div class="grid gap-4 md:grid-cols-2">
                    <div class="space-y-1">
                        <p class="text-sm font-medium text-muted-foreground">ID</p>
                        <p class="font-medium">{user.id}</p>
                    </div>
                    <div class="space-y-1">
                        <p class="text-sm font-medium text-muted-foreground">Rol</p>
                        <div class="flex">
                            <span class={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 ${user.role === 'Admin' ? 'bg-primary text-primary-foreground' : 'bg-secondary text-secondary-foreground'}`}>
                                {user.role}
                            </span>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <p class="text-sm font-medium text-muted-foreground">Usuario</p>
                        <p class="font-medium">{user.username}</p>
                    </div>
                    <div class="space-y-1">
                        <p class="text-sm font-medium text-muted-foreground">Email</p>
                        <p class="font-medium">{(user as any).email || 'No registrado'}</p>
                    </div>
                    <div class="space-y-1">
                        <p class="text-sm font-medium text-muted-foreground">Fecha de Registro</p>
                        <p class="font-medium">{user.created_at ? formatDate(user.created_at) : '-'}</p>
                    </div>
                </div>
            </CardContent>
        </Card>
    </div>
</DashboardLayout>