---
import DashboardLayout from '../../../components/layout/dashboard-layout.astro';
import { Card, CardHeader, CardTitle, CardDescription, CardContent, Input } from '../../../components/ui';
import Button from '../../../components/ui/button.astro';
import { api } from '../../../lib/api';
import type { User } from '../../../types';
import { ArrowLeft } from 'lucide-react';

export const prerender = false;

const { id } = Astro.params;
const userId = parseInt(id || '0');
const currentUser = Astro.locals.user;

let user: User | null = null;
let error = null;

try {
    const token = Astro.cookies.get("auth_token")?.value || Astro.cookies.get("session")?.value;
    if (!token) throw new Error("No token found");
    
    // Obtener datos del usuario
    user = await api.getUser(userId, token);
} catch (e: any) {
    console.error("Error fetching user:", e);
    error = e.message || "Usuario no encontrado";
}

if (error) {
    return Astro.redirect('/dashboard/users');
}

const isAdmin = currentUser?.role === 'Admin';
---

<DashboardLayout 
  title={`Editar Usuario: ${user?.username}`} 
  description={`ID: ${user?.id} • Creado el ${user ? new Date(user.created_at).toLocaleDateString() : ''}`}
  currentPath="/dashboard/users/"
>
    <div class="space-y-6 max-w-2xl mx-auto">
        <div class="flex items-center gap-2">
            <a href="/dashboard/users" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground h-9 w-9">
                <ArrowLeft className="h-4 w-4" />
            </a>
            <h1 class="text-2xl font-bold tracking-tight">Editar Usuario</h1>
        </div>

        <Card>
            <CardHeader>
                <CardTitle>Detalles del Usuario</CardTitle>
                <CardDescription>
                    Actualiza la información del usuario.
                </CardDescription>
            </CardHeader>
            <CardContent>
                {user && (
                    <form id="edit-user-form" class="space-y-4" data-id={user.id}>
                        <div class="space-y-2">
                            <label class="text-sm font-medium">Nombre de Usuario</label>
                            <Input 
                                type="text" 
                                value={user.username} 
                                disabled
                                class="bg-muted text-muted-foreground cursor-not-allowed"
                            />
                            <p class="text-[0.8rem] text-muted-foreground">El nombre de usuario no se puede cambiar.</p>
                        </div>

                        <div class="space-y-2">
                            <label for="email" class="text-sm font-medium">Email</label>
                            <Input 
                                type="email" 
                                id="email" 
                                name="email" 
                                value={(user as any).email || ''} 
                                placeholder="usuario@ejemplo.com"
                            />
                        </div>

                        <div class="space-y-2">
                            <label for="role" class="text-sm font-medium">Rol</label>
                            <select 
                                id="role" 
                                name="role" 
                                class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                                disabled={!isAdmin}
                            >
                                <option value="User" selected={user.role === 'User'}>User</option>
                                <option value="Admin" selected={user.role === 'Admin'}>Admin</option>
                            </select>
                            {!isAdmin && <p class="text-[0.8rem] text-muted-foreground">Solo los administradores pueden cambiar roles.</p>}
                        </div>

                        <div class="pt-4 flex justify-end gap-2">
                            <Button variant="outline" type="button" onclick="history.back()">Cancelar</Button>
                            <Button type="submit" id="save-btn">Guardar Cambios</Button>
                        </div>
                    </form>
                )}
            </CardContent>
        </Card>
    </div>
</DashboardLayout>

<script>
    import { api } from '../../../lib/api';
    import { addToast } from '../../../stores/toast';

    const form = document.getElementById('edit-user-form') as HTMLFormElement;
    const saveBtn = document.getElementById('save-btn') as HTMLButtonElement;

    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = parseInt(form.dataset.id || '0');
            const email = (document.getElementById('email') as HTMLInputElement).value;
            const role = (document.getElementById('role') as HTMLSelectElement).value;

            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';

            try {
                await api.updateUser(userId, { email, role });
                addToast({ type: 'success', message: 'Usuario actualizado correctamente' });

                setTimeout(() => {
                    window.location.href = '/dashboard/users';
                }, 1500);
            } catch (error: any) {
                addToast({ type: 'error', message: error.message || 'Error al actualizar' });
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Guardar Cambios';
            }
        });
    }
</script>