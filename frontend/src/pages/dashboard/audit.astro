---
import DashboardLayout from '../../components/layout/dashboard-layout.astro'
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '../../components/ui'
import Button from '../../components/ui/button.astro'
import type { AuditLog } from '../../types'

export const prerender = false;

let auditLogs: AuditLog[] = [];
let error = null;

try {
  const token = Astro.cookies.get("session")?.value || Astro.cookies.get("token")?.value;
  if (!token) throw new Error("No token found");
  
  const result = await api.getAuditLogs({ limit: 50 }, token);
  auditLogs = result.data;
  console.log("[Audit Page] First log sample:", JSON.stringify(auditLogs[0], null, 2));
} catch (e: any) {
  console.error("Error fetching audit logs:", e);
  error = e.message;
}
---

<DashboardLayout 
  title="Auditoría" 
  description="Registro de actividad del sistema"
  currentPath="/dashboard/audit/"
  isAdmin={true}
>
  <div id="loading-state" class="flex items-center justify-center min-h-[60vh]">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
      <p class="text-muted-foreground">Cargando auditoría...</p>
    </div>
  </div>

  <div id="audit-content" class="hidden space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold tracking-tight">Auditoría</h1>
        <p class="text-muted-foreground">
          Total: <span id="total-logs">0</span> eventos registrados
        </p>
      </div>
      
      <div class="flex items-center gap-2">
        <Button id="refresh-btn" variant="outline" size="sm">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>
          Actualizar
        </Button>
        <Button id="export-btn" variant="outline" size="sm">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
          Exportar
        </Button>
      </div>
    </div>

    <!-- Filtros -->
    <Card>
      <CardContent class="pt-6">
        <div class="grid gap-4 md:grid-cols-3">
          <div>
            <label class="text-sm font-medium mb-2 block">Buscar</label>
            <input 
              type="text" 
              id="search-input"
              placeholder="Buscar por acción o usuario..."
              class="h-10 w-full rounded-md border border-input bg-background px-3 text-sm"
            />
          </div>
          <div>
            <label class="text-sm font-medium mb-2 block">Acción</label>
            <select id="action-filter" class="h-10 w-full rounded-md border border-input bg-background px-3 text-sm">
              <option value="">Todas las acciones</option>
              <option value="LOGIN">Login</option>
              <option value="LOGOUT">Logout</option>
              <option value="CREATE_USER">Crear Usuario</option>
              <option value="DELETE_USER">Eliminar Usuario</option>
              <option value="UPDATE_USER">Actualizar Usuario</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-medium mb-2 block">Fecha</label>
            <select id="date-filter" class="h-10 w-full rounded-md border border-input bg-background px-3 text-sm">
              <option value="">Todas las fechas</option>
              <option value="today">Hoy</option>
              <option value="week">Esta semana</option>
              <option value="month">Este mes</option>
            </select>
          </div>
        </div>
      </CardContent>
    </Card>

    <!-- Timeline de auditoría -->
    <Card>
      <CardHeader>
        <CardTitle>Registro de Eventos</CardTitle>
        <CardDescription>
          Historial cronológico de todas las acciones realizadas en el sistema.
        </CardDescription>
      </CardHeader>
      <CardContent>
        <div id="audit-timeline" class="space-y-0">
          {error ? (
            <p class="text-destructive text-center py-4">{error}</p>
          ) : auditLogs.length === 0 ? (
            <p class="text-muted-foreground text-center py-4">No hay registros de auditoría.</p>
          ) : (
            auditLogs.map((log) => (
              <div class="relative pl-6 pb-6 border-l border-border last:border-0 last:pb-0">
                <div class="absolute left-[-5px] top-0 h-2.5 w-2.5 rounded-full bg-primary ring-4 ring-background" />
                <div class="flex flex-col gap-1">
                  <div class="flex items-center justify-between">
                    <span class="text-sm font-medium">{log.action}</span>
                    <span class="text-xs text-muted-foreground">{formatDate(log.created_at || log.timestamp || "")}</span>
                  </div>
                  <p class="text-sm text-muted-foreground">
                    Usuario: <span class="font-medium text-foreground">{log.username || log.admin_username || "Sistema"}</span>
                  </p>
                  {(log.details || log.target) && (
                    <p class="text-xs text-muted-foreground mt-1 bg-muted p-2 rounded-md">
                      {log.details || `Objetivo: ${log.target}`}
                    </p>
                  )}
                </div>
              </div>
            ))
          )}
        </div>
        
        <!-- Controles de paginación -->
        <div id="pagination-controls" class="flex items-center justify-between pt-6 border-t mt-6">
          <!-- Se renderizará dinámicamente -->
        </div>
      </CardContent>
    </Card>
  </div>

  <!-- Error State -->
  <div id="error-state" class="hidden flex items-center justify-center min-h-[60vh]">
    <div class="text-center max-w-md">
      <div class="h-12 w-12 rounded-full bg-destructive/10 flex items-center justify-center mx-auto mb-4">
        <svg class="h-6 w-6 text-destructive" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
        </svg>
      </div>
      <h3 class="text-lg font-semibold mb-2">Error al cargar auditoría</h3>
      <p class="text-muted-foreground mb-4" id="error-message">No se pudieron cargar los logs</p>
      <Button id="retry-btn">Reintentar</Button>
    </div>
  </div>
</DashboardLayout>

<script>
  import { api } from '../../lib/api';
  import { formatDate } from '../../lib/utils';
  import type { AuditLog } from '../../types';

  // DOM Elements
  const loadingState = document.getElementById('loading-state');
  const auditContent = document.getElementById('audit-content');
  const errorState = document.getElementById('error-state');
  const timelineContainer = document.getElementById('audit-timeline');
  const paginationContainer = document.getElementById('pagination-controls');
  const totalLogsEl = document.getElementById('total-logs');

  // State
  let logs: AuditLog[] = [];
  let filteredLogs: AuditLog[] = [];
  let currentPage = 1;
  const itemsPerPage = 10;

  // Constants
  const actionColors: Record<string, string> = {
    'LOGIN': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400',
    'LOGOUT': 'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-400',
    'CREATE_USER': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400',
    'DELETE_USER': 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400',
    'UPDATE_USER': 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400',
  };

  const actionIcons: Record<string, string> = {
    'LOGIN': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>',
    'LOGOUT': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>',
    'CREATE_USER': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" x2="20" y1="8" y2="14"/><line x1="23" x2="17" y1="11" y2="11"/></svg>',
    'DELETE_USER': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="18" x2="23" y1="11" y2="11"/></svg>',
    'UPDATE_USER': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M17 8l5-5"/><path d="M22 8L17 3"/></svg>',
  };

  function renderTimeline() {
    if (!timelineContainer) return;
    
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageLogs = filteredLogs.slice(start, end);
    
    if (pageLogs.length === 0) {
      timelineContainer.innerHTML = `
        <div class="text-center py-12 text-muted-foreground">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" class="mx-auto mb-4 opacity-50"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
          <p>No hay eventos que coincidan con los filtros</p>
        </div>
      `;
      if (paginationContainer) paginationContainer.innerHTML = '';
      return;
    }
    
    // Agrupar por fecha
    const grouped = pageLogs.reduce((acc, log) => {
      // Usar formatDate helper o lógica robusta
      const dateStr = log.created_at || log.timestamp || "";
      const d = dateStr.includes(' ') ? new Date(dateStr.replace(' ', 'T')) : new Date(dateStr);
      
      const date = d.toLocaleDateString('es-ES', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      if (!acc[date]) acc[date] = [];
      acc[date].push(log);
      return acc;
    }, {} as Record<string, AuditLog[]>);
    
    timelineContainer.innerHTML = Object.entries(grouped).map(([date, dayLogs]) => `
      <div class="relative pl-8 pb-8 last:pb-0">
        <!-- Línea vertical -->
        <div class="absolute left-3 top-2 bottom-0 w-px bg-border"></div>
        
        <!-- Marcador de fecha -->
        <div class="absolute left-0 top-1">
          <div class="h-6 w-6 rounded-full bg-primary/10 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-primary"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
          </div>
        </div>
        
        <!-- Fecha -->
        <h3 class="font-semibold text-sm mb-4 capitalize">${date}</h3>
        
        <!-- Eventos del día -->
        <div class="space-y-3">
          ${dayLogs.map(log => `
            <div class="relative pl-6 pb-4 last:pb-0">
              <!-- Punto del evento -->
              <div class="absolute left-0 top-1">
                <div class="h-3 w-3 rounded-full bg-primary/30"></div>
              </div>
              
              <div class="rounded-lg border bg-card p-4 hover:bg-accent/50 transition-colors">
                <div class="flex items-start justify-between gap-4">
                  <div class="flex items-start gap-3">
                    <div class="h-8 w-8 rounded-full ${actionColors[log.action] || 'bg-primary/10 text-primary'} flex items-center justify-center shrink-0">
                      ${actionIcons[log.action] || actionIcons['LOGIN']}
                    </div>
                    <div>
                      <p class="font-medium text-sm">${log.action.replace(/_/g, ' ')}</p>
                      <p class="text-xs text-muted-foreground mt-0.5">
                        Por: <span class="font-medium text-foreground">${log.username || log.admin_username || "Sistema"}</span>
                      </p>
                      ${(log.details || log.target) ? `
                        <p class="text-xs text-muted-foreground mt-1">
                          ${log.details || `Objetivo: ${log.target}`}
                        </p>
                      ` : ''}
                    </div>
                  </div>
                  <time class="text-xs text-muted-foreground shrink-0">
                    ${formatDate(log.created_at || log.timestamp || "")}
                  </time>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `).join('');
    
    // Renderizar paginación
    const totalPages = Math.ceil(filteredLogs.length / itemsPerPage);
    if (totalPages > 1) {
      paginationContainer!.innerHTML = `
        <div class="text-sm text-muted-foreground">
          Mostrando ${start + 1} a ${Math.min(end, filteredLogs.length)} de ${filteredLogs.length} eventos
        </div>
        <div class="flex items-center gap-1">
          <button id="prev-page" class="inline-flex h-8 w-8 items-center justify-center rounded-md border text-sm font-medium transition-colors ${currentPage === 1 ? 'pointer-events-none opacity-50' : 'hover:bg-accent hover:text-accent-foreground'}">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>
          </button>
          
          ${Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
            const pageNum = i + 1;
            const isActive = pageNum === currentPage;
            return `<button class="page-btn inline-flex h-8 w-8 items-center justify-center rounded-md text-sm font-medium transition-colors ${isActive ? 'bg-primary text-primary-foreground' : 'hover:bg-accent hover:text-accent-foreground'}" data-page="${pageNum}">${pageNum}</button>`;
          }).join('')}
          
          ${totalPages > 5 ? '<span class="px-2 text-muted-foreground">...</span>' : ''}
          
          <button id="next-page" class="inline-flex h-8 w-8 items-center justify-center rounded-md border text-sm font-medium transition-colors ${currentPage === totalPages ? 'pointer-events-none opacity-50' : 'hover:bg-accent hover:text-accent-foreground'}">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
          </button>
        </div>
      `;
      
      // Event listeners para paginación
      document.getElementById('prev-page')?.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderTimeline();
        }
      });
      
      document.getElementById('next-page')?.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderTimeline();
        }
      });
      
      document.querySelectorAll('.page-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          currentPage = parseInt((e.currentTarget as HTMLElement).dataset.page!);
          renderTimeline();
        });
      });
    } else {
      paginationContainer!.innerHTML = `
        <div class="text-sm text-muted-foreground">
          Mostrando ${filteredLogs.length} eventos
        </div>
        <div></div>
      `;
    }
  }

  // Aplicar filtros
  function applyFilters() {
    const searchTerm = (document.getElementById('search-input') as HTMLInputElement)?.value.toLowerCase() || '';
    const actionFilter = (document.getElementById('action-filter') as HTMLSelectElement)?.value || '';
    const dateFilter = (document.getElementById('date-filter') as HTMLSelectElement)?.value || '';
    
    filteredLogs = logs.filter(log => {
      // Filtro de búsqueda
      if (searchTerm) {
        const searchString = `${log.action} ${log.username} ${log.details}`.toLowerCase();
        if (!searchString.includes(searchTerm)) return false;
      }
      
      // Filtro de acción
      if (actionFilter && log.action !== actionFilter) return false;
      
      // Filtro de fecha
      if (dateFilter) {
        const logDate = new Date(log.created_at);
        const now = new Date();
        
        if (dateFilter === 'today') {
          if (logDate.toDateString() !== now.toDateString()) return false;
        } else if (dateFilter === 'week') {
          const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          if (logDate < weekAgo) return false;
        } else if (dateFilter === 'month') {
          if (logDate.getMonth() !== now.getMonth() || logDate.getFullYear() !== now.getFullYear()) return false;
        }
      }
      
      return true;
    });
    
    currentPage = 1;
    renderTimeline();
  }

  // Cargar logs
  async function loadLogs() {
    try {
      const response = await api.getAuditLogs({ limit: 100 }); // Cargar más para filtrado local
      // Asegurar que response.data sea un array
      logs = Array.isArray(response?.data) ? response.data : [];
      filteredLogs = [...logs];
      
      if (totalLogsEl) {
        totalLogsEl.textContent = logs.length.toString();
      }
      
      renderTimeline();
    } catch (err: any) {
      console.error('Error loading audit logs:', err);
      throw err;
    }
  }

  // Toast notifications
  function showToast(message: string, type: 'success' | 'error' | 'info' = 'info') {
    const toast = document.createElement('div');
    const colors = {
      success: 'bg-green-500',
      error: 'bg-destructive',
      info: 'bg-primary',
    };
    
    toast.className = `fixed bottom-4 right-4 ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg z-50 transition-all duration-300`;
    toast.innerHTML = `<div class="flex items-center gap-2"><span>${message}</span></div>`;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(20px)';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // Inicializar
  async function init() {
    try {
      // Verificar autenticación
      await api.getDashboard();
      
      // Mostrar contenido
      loadingState?.classList.add('hidden');
      auditContent?.classList.remove('hidden');
      
      // Cargar datos
      await loadLogs();
      
      // Event listeners
      document.getElementById('refresh-btn')?.addEventListener('click', async () => {
        await loadLogs();
        showToast('Auditoría actualizada', 'success');
      });
      
      document.getElementById('retry-btn')?.addEventListener('click', async () => {
        errorState?.classList.add('hidden');
        loadingState?.classList.remove('hidden');
        await init();
      });
      
      document.getElementById('export-btn')?.addEventListener('click', () => {
        showToast('Exportación en desarrollo', 'info');
      });
      
      // Filtros
      document.getElementById('search-input')?.addEventListener('input', applyFilters);
      document.getElementById('action-filter')?.addEventListener('change', applyFilters);
      document.getElementById('date-filter')?.addEventListener('change', applyFilters);
      
    } catch (err: any) {
      console.error('Init error:', err);
      
      if (err.status === 401) {
        window.location.href = '/login/';
        return;
      }
      
      loadingState?.classList.add('hidden');
      errorState?.classList.remove('hidden');
      document.getElementById('error-message')!.textContent = err.message || 'Error al cargar la auditoría';
    }
  }

  // Ejecutar
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>
