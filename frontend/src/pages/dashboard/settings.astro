---
import DashboardLayout from '../../components/layout/dashboard-layout.astro'
import ProfileTab from '../../components/settings/ProfileTab.astro'
import SecurityTab from '../../components/settings/SecurityTab.astro'
import AppearanceTab from '../../components/settings/AppearanceTab.astro'
import Button from '../../components/ui/button.astro'

export const prerender = false;
---

<DashboardLayout 
  title="Configuración" 
  description="Gestiona tu cuenta y preferencias"
  currentPath="/dashboard/settings/"
>
  <div id="loading-state" class="flex items-center justify-center min-h-[60vh]">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
      <p class="text-muted-foreground">Cargando configuración...</p>
    </div>
  </div>

  <div id="settings-content" class="hidden max-w-4xl mx-auto space-y-6">
    <div>
      <h1 class="text-2xl font-bold tracking-tight">Configuración</h1>
      <p class="text-muted-foreground">
        Gestiona tu perfil, seguridad y preferencias del sistema.
      </p>
    </div>

    <div class="grid gap-6 md:grid-cols-[250px_1fr]">
      <!-- Tabs de navegación -->
      <nav class="flex flex-col gap-2">
        <button class="tab-btn text-left px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-primary text-primary-foreground" data-tab="profile">
          <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            Perfil
          </div>
        </button>
        <button class="tab-btn text-left px-4 py-2 rounded-lg text-sm font-medium transition-colors text-muted-foreground hover:bg-accent hover:text-accent-foreground" data-tab="security">
          <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            Seguridad
          </div>
        </button>
        <button class="tab-btn text-left px-4 py-2 rounded-lg text-sm font-medium transition-colors text-muted-foreground hover:bg-accent hover:text-accent-foreground" data-tab="appearance">
          <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
            Apariencia
          </div>
        </button>
      </nav>

      <!-- Contenido de tabs -->
      <div class="space-y-6">
        <div id="tab-profile" class="tab-content">
          <ProfileTab />
        </div>
        <div id="tab-security" class="tab-content hidden">
          <SecurityTab />
        </div>
        <div id="tab-appearance" class="tab-content hidden">
          <AppearanceTab />
        </div>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div id="error-state" class="hidden items-center justify-center min-h-[60vh]">
    <div class="text-center max-w-md">
      <div class="h-12 w-12 rounded-full bg-destructive/10 flex items-center justify-center mx-auto mb-4">
        <svg class="h-6 w-6 text-destructive" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
        </svg>
      </div>
      <h3 class="text-lg font-semibold mb-2">Error al cargar configuración</h3>
      <p class="text-muted-foreground mb-4" id="error-message">No se pudo cargar la información</p>
      <Button id="retry-btn">Reintentar</Button>
    </div>
  </div>
</DashboardLayout>

<script>
  import { api } from '../../lib/api'
  import { loadUserData, showToast } from '../../components/settings/settings'
  import { initTabs } from '../../components/settings/tabs'
  import { initThemeSelector } from '../../components/settings/theme'
  import { initEventListeners } from '../../components/settings/events'

  const loadingState = document.getElementById('loading-state')
  const settingsContent = document.getElementById('settings-content')
  const errorState = document.getElementById('error-state')

  async function init() {
    try {
      const dashboardData = await api.getDashboard()
      
      loadingState?.classList.add('hidden')
      settingsContent?.classList.remove('hidden')
      
      loadUserData(dashboardData.user)
      initTabs()
      initThemeSelector()
      initEventListeners()
      
    } catch (err: any) {
      console.error('Init error:', err)
      
      if (err.status === 401) {
        window.location.href = '/login/'
        return
      }
      
      loadingState?.classList.add('hidden')
      errorState?.classList.remove('hidden')
      errorState?.classList.add('flex')
      document.getElementById('error-message')!.textContent = err.message || 'Error al cargar la configuración'
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init)
  } else {
    init()
  }
</script>
