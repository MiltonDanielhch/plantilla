---
const { isAdmin = false } = Astro.props;
---

<div class="user-list-container" data-is-admin={isAdmin} style="margin-top: 2rem; padding: 1rem; border: 1px solid #374151; border-radius: 8px; background-color: #1f2937;">
    <h3 style="color: #10b981; margin-bottom: 1rem;">üì° Frecuencia de Usuarios</h3>
    
    <!-- Barra de B√∫squeda -->
    <div style="margin-bottom: 1rem;">
        <input type="text" id="user-search-input" placeholder="üîç Buscar por nombre o email..." 
            style="width: 100%; padding: 0.75rem; background-color: #374151; border: 1px solid #4b5563; border-radius: 6px; color: #e5e7eb; outline: none;"
        />
    </div>

    <ul id="user-list" style="list-style: none; padding: 0;">
        <li style="color: #9ca3af;">Sintonizando...</li>
    </ul>
</div>

<script>
    import { API_BASE_URL } from '../config';
    async function fetchUsers(query = '') {
        const list = document.getElementById('user-list');
        const container = document.querySelector('.user-list-container') as HTMLElement;
        const isAdmin = container?.dataset.isAdmin === 'true';

        if (!list) return;

        try {
            // Construir URL con par√°metro de b√∫squeda si existe
            const url = query
                ? `${API_BASE_URL}/users?q=${encodeURIComponent(query)}`
                : `${API_BASE_URL}/users`;

            const res = await fetch(url);
            if (!res.ok) throw new Error('Error de se√±al');
            
            const users = await res.json();
            
            if (users.length === 0) {
                list.innerHTML = '<li style="color: #9ca3af;">Sin se√±ales detectadas.</li>';
                return;
            }

            list.innerHTML = users.map((u: any) => `
                <li style="padding: 0.5rem; border-bottom: 1px solid #374151; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-weight: bold; color: #e5e7eb; display: flex; align-items: center; gap: 0.5rem;">
                            ${u.username}
                            <span style="font-size: 0.7em; background: ${u.role === 'Admin' ? '#7f1d1d' : '#374151'}; color: ${u.role === 'Admin' ? '#fca5a5' : '#9ca3af'}; padding: 2px 6px; border-radius: 4px; border: 1px solid ${u.role === 'Admin' ? '#ef4444' : '#4b5563'};">
                                ${u.role}
                            </span>
                        </span>
                        <span style="color: #6b7280; font-size: 0.8em;">${u.created_at}</span>
                    </div>
                    ${isAdmin ? `
                        <button 
                            class="delete-btn" 
                            data-id="${u.id}"
                            style="background: #7f1d1d; color: #fca5a5; border: 1px solid #ef4444; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;"
                        >
                            ELIMINAR
                        </button>
                    ` : ''}
                </li>
            `).join('');

            // Activar listeners para los botones de eliminar
            if (isAdmin) {
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const target = e.target as HTMLElement;
                        const id = target.dataset.id;
                        if (!id) return;

                        if (!confirm('‚ö†Ô∏è ¬øConfirmas la eliminaci√≥n de este agente?')) return;

                        try {
                            const res = await fetch(`${API_BASE_URL}/users/${id}`, {
                                method: 'DELETE',
                                credentials: 'include' // Importante: Env√≠a la cookie de Admin
                            });

                            if (res.ok) {
                                alert('Agente eliminado.');
                                fetchUsers(); // Recargar lista
                            } else {
                                alert('‚õî Error: No tienes autorizaci√≥n o fall√≥ el sistema.');
                            }
                        } catch (err) {
                            console.error(err);
                            alert('Error de conexi√≥n.');
                        }
                    });
                });
            }

        } catch (error) {
            console.error(error);
            list.innerHTML = '<li style="color: #ef4444;">‚ö†Ô∏è Error de conexi√≥n con el N√∫cleo</li>';
        }
    }

    // Inicializaci√≥n y Eventos
    fetchUsers();

    // B√∫squeda con Debounce (para no saturar el servidor)
    const searchInput = document.getElementById('user-search-input');
    let timeout: any;
    searchInput?.addEventListener('input', (e) => {
        const val = (e.target as HTMLInputElement).value;
        clearTimeout(timeout);
        timeout = setTimeout(() => fetchUsers(val), 300);
    });
</script>