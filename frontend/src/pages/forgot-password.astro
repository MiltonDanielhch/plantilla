---
import Layout from '../components/layout/layout.astro'
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '../components/ui'
import Button from '../components/ui/button.astro'
---

<Layout title="Recuperar Contraseña - Sintonía 3026">
  <div class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md space-y-6">
      <!-- Logo -->
      <div class="text-center space-y-2">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gradient-to-br from-violet-500 to-fuchsia-500 mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            <path d="m9 12 2 2 4-4"/>
          </svg>
        </div>
        <h1 class="text-3xl font-bold tracking-tight">Sintonía 3026</h1>
        <p class="text-muted-foreground">Recupera el acceso a tu cuenta</p>
      </div>

      <!-- Formulario -->
      <Card>
        <CardHeader>
          <CardTitle>Recuperar Contraseña</CardTitle>
          <CardDescription>
            Ingresa tu email y te enviaremos instrucciones para restablecer tu contraseña.
          </CardDescription>
        </CardHeader>
        <CardContent class="space-y-4">
          <form id="forgot-form" class="space-y-4">
            <div class="space-y-2">
              <label class="text-sm font-medium" for="email">Email</label>
              <input
                id="email"
                type="email"
                name="email"
                placeholder="tu@email.com"
                required
                class="h-10 w-full rounded-md border border-input bg-background px-3 text-sm"
              />
            </div>

            <Button type="submit" class="w-full" id="submit-btn">
              Enviar instrucciones
            </Button>
          </form>

          <!-- Success Message -->
          <div id="success-message" class="hidden space-y-4">
            <div class="p-4 bg-green-500/10 text-green-600 rounded-lg">
              <div class="flex items-center gap-2 mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                <span class="font-medium">¡Email enviado!</span>
              </div>
              <p class="text-sm">
                Si el email existe en nuestra base de datos, recibirás instrucciones para restablecer tu contraseña.
              </p>
            </div>
            <a href="/login/" class="block text-center text-sm text-primary hover:underline">
              Volver al login
            </a>
          </div>

          <div class="text-center text-sm">
            <a href="/login/" class="text-primary hover:underline">
              ← Volver al inicio de sesión
            </a>
          </div>
        </CardContent>
      </Card>

      <!-- Error Toast -->
      <div id="error-toast" class="hidden fixed bottom-4 right-4 bg-destructive text-white px-4 py-3 rounded-lg shadow-lg">
        <span id="error-message"></span>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { api } from '../lib/api'

  const form = document.getElementById('forgot-form')
  const submitBtn = document.getElementById('submit-btn')
  const successMessage = document.getElementById('success-message')
  const errorToast = document.getElementById('error-toast')
  const errorMessage = document.getElementById('error-message')

  function showError(message: string) {
    errorMessage!.textContent = message
    errorToast!.classList.remove('hidden')
    setTimeout(() => {
      errorToast!.classList.add('hidden')
    }, 5000)
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault()
    
    const email = (document.getElementById('email') as HTMLInputElement).value
    
    // Validación básica
    if (!email || !email.includes('@')) {
      showError('Por favor ingresa un email válido')
      return
    }

    // Mostrar estado de carga
    submitBtn!.disabled = true
    submitBtn!.innerHTML = `
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Enviando...
    `

    try {
      await api.forgotPassword(email)
      
      // Mostrar mensaje de éxito
      form!.classList.add('hidden')
      successMessage!.classList.remove('hidden')
      
    } catch (err: any) {
      showError(err.message || 'Error al enviar el email')
      submitBtn!.disabled = false
      submitBtn!.textContent = 'Enviar instrucciones'
    }
  })
</script>