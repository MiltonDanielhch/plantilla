---
export const prerender = false;
import '../styles/globals.css';
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Verificación de Email</title>
  </head>
  <body class="min-h-screen bg-slate-50 flex items-center justify-center p-4">
    <div class="max-w-md w-full bg-white rounded-xl shadow-lg p-8 text-center space-y-6">
      
      <!-- Estado Cargando -->
      <div id="loading" class="flex flex-col items-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <h2 class="text-2xl font-bold text-slate-900">Verificando tu correo...</h2>
        <p class="text-slate-500 mt-2">Por favor espera un momento mientras validamos tu token.</p>
      </div>

      <!-- Estado Éxito -->
      <div id="success" class="hidden flex-col items-center">
        <div class="h-16 w-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        </div>
        <h2 class="text-2xl font-bold text-green-600">¡Email Verificado!</h2>
        <p class="text-slate-500 mt-2">Tu correo ha sido confirmado correctamente.</p>
        <p class="text-sm text-slate-400 mt-4">Redirigiendo a configuración...</p>
      </div>

      <!-- Estado Error -->
      <div id="error" class="hidden flex-col items-center">
        <div class="h-16 w-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" x2="9" y1="9" y2="15"/><line x1="9" x2="15" y1="9" y2="15"/></svg>
        </div>
        <h2 class="text-2xl font-bold text-red-600">Error de Verificación</h2>
        <p id="error-message" class="text-slate-500 mt-2">El enlace es inválido o ha expirado.</p>
        <a href="/dashboard/settings" class="mt-6 inline-flex items-center justify-center rounded-md text-sm font-medium bg-slate-900 text-white hover:bg-slate-800 h-10 px-4 py-2 transition-colors">
          Volver a Configuración
        </a>
      </div>

    </div>

    <script>
      import { api } from '../lib/api';

      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');

      const loading = document.getElementById('loading');
      const success = document.getElementById('success');
      const error = document.getElementById('error');
      const errorMsg = document.getElementById('error-message');

      if (!token) {
        loading?.classList.add('hidden');
        error?.classList.remove('hidden');
        error?.classList.add('flex');
        if (errorMsg) errorMsg.textContent = 'Token no encontrado en la URL';
      } else {
        api.verifyEmail(token)
          .then(() => {
            loading?.classList.add('hidden');
            success?.classList.remove('hidden');
            success?.classList.add('flex');
            setTimeout(() => window.location.href = '/dashboard/settings', 2000);
          })
          .catch((err) => {
            loading?.classList.add('hidden');
            error?.classList.remove('hidden');
            error?.classList.add('flex');
            if (errorMsg) {
              // Si es 401, significa que el token es inválido, expiró o ya se usó
              const isAuthError = err.status === 401 || err.message?.includes('401');
              errorMsg.textContent = isAuthError ? 'El enlace ya fue utilizado o ha expirado.' : (err.message || 'Error al verificar el email');
            }
          });
      }
    </script>
  </body>
</html>