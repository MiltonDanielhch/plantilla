---
import DashboardLayout from '../../components/layout/dashboard-layout.astro'
import AuditFilters from '../../components/audit/AuditFilters.astro'
import AuditTimeline from '../../components/audit/AuditTimeline.astro'
import Button from '../../components/ui/button.astro'
import { api } from '../../lib/api'
import type { AuditLog } from '../../types'

export const prerender = false;

let auditLogs: AuditLog[] = [];
let error = null;

try {
  const token = Astro.cookies.get("auth_token")?.value || Astro.cookies.get("session")?.value;
  if (!token) throw new Error("No token found");
  
  const result = await api.getAuditLogs({ limit: 50 }, token);
  auditLogs = result.data;
} catch (e: any) {
  console.error("Error fetching audit logs:", e);
  error = e.message;
}
---

<DashboardLayout 
  title="Auditoría" 
  description="Registro de actividad del sistema"
  currentPath="/dashboard/audit/"
>
  <div id="loading-state" class="space-y-6">
    <div class="flex items-center justify-between">
      <div class="space-y-2">
        <div class="h-8 w-48 bg-muted animate-pulse rounded"></div>
        <div class="h-4 w-64 bg-muted animate-pulse rounded"></div>
      </div>
    </div>
    <div class="h-30 w-full bg-muted animate-pulse rounded-xl"></div>
  </div>

  <div id="audit-content" class="hidden space-y-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold tracking-tight">Auditoría</h1>
        <p class="text-muted-foreground">
          Total: <span id="total-logs">0</span> eventos registrados
        </p>
      </div>
      
      <div class="flex items-center gap-2">
        <Button id="refresh-btn" variant="outline" size="sm">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>
          Actualizar
        </Button>
        <Button id="export-btn" variant="outline" size="sm">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
          Exportar CSV
        </Button>
      </div>
    </div>

    <AuditFilters />
    <AuditTimeline />
  </div>

  <div id="error-state" class="hidden items-center justify-center min-h-[60vh]">
    <div class="text-center max-w-md">
      <div class="h-12 w-12 rounded-full bg-destructive/10 flex items-center justify-center mx-auto mb-4">
        <svg class="h-6 w-6 text-destructive" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
        </svg>
      </div>
      <h3 class="text-lg font-semibold mb-2">Error al cargar auditoría</h3>
      <p class="text-muted-foreground mb-4" id="error-message">No se pudieron cargar los logs</p>
      <Button id="retry-btn">Reintentar</Button>
    </div>
  </div>
</DashboardLayout>

<script>
  import { api } from '../../lib/api';
  import { renderTimeline, showToast } from '../../components/audit/audit';
  import type { AuditLog } from '../../types';

  const loadingState = document.getElementById('loading-state');
  const auditContent = document.getElementById('audit-content');
  const errorState = document.getElementById('error-state');
  const timelineContainer = document.getElementById('audit-timeline');
  const paginationContainer = document.getElementById('pagination-controls');
  const totalLogsEl = document.getElementById('total-logs');

  let logs: AuditLog[] = [];
  let filteredLogs: AuditLog[] = [];
  let currentPage = 1;
  const itemsPerPage = 10;

  function applyFilters() {
    const searchTerm = (document.getElementById('search-input') as HTMLInputElement)?.value.toLowerCase() || '';
    const actionFilter = (document.getElementById('action-filter') as HTMLSelectElement)?.value || '';
    const dateFilter = (document.getElementById('date-filter') as HTMLSelectElement)?.value || '';
    
    filteredLogs = logs.filter(log => {
      if (searchTerm) {
        const searchString = `${log.action} ${log.username} ${log.details}`.toLowerCase();
        if (!searchString.includes(searchTerm)) return false;
      }
      
      if (actionFilter && log.action !== actionFilter) return false;
      
      if (dateFilter) {
        const dateStr = log.created_at || log.timestamp || "";
        const logDate = new Date(dateStr);
        const now = new Date();
        
        if (dateFilter === 'today') {
          if (logDate.toDateString() !== now.toDateString()) return false;
        } else if (dateFilter === 'week') {
          const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          if (logDate < weekAgo) return false;
        } else if (dateFilter === 'month') {
          if (logDate.getMonth() !== now.getMonth() || logDate.getFullYear() !== now.getFullYear()) return false;
        }
      }
      
      return true;
    });
    
    currentPage = 1;
    render();
  }

  function render() {
    if (timelineContainer && paginationContainer) {
      renderTimeline(filteredLogs, currentPage, itemsPerPage, timelineContainer, paginationContainer, (page) => {
        currentPage = page;
        render();
      });
    }
    if (totalLogsEl) {
      totalLogsEl.textContent = logs.length.toString();
    }
  }

  async function loadLogs() {
    try {
      const response = await api.getAuditLogs({ limit: 100 });
      logs = Array.isArray(response?.data) ? response.data : [];
      filteredLogs = [...logs];
      render();
    } catch (err: any) {
      console.error('Error loading audit logs:', err);
      throw err;
    }
  }

  async function init() {
    try {
      await api.getDashboard();
      
      loadingState?.classList.add('hidden');
      auditContent?.classList.remove('hidden');
      
      await loadLogs();
      
      document.getElementById('refresh-btn')?.addEventListener('click', async () => {
        await loadLogs();
        showToast('Auditoría actualizada', 'success');
      });
      
      document.getElementById('retry-btn')?.addEventListener('click', async () => {
        errorState?.classList.add('hidden');
        loadingState?.classList.remove('hidden');
        await init();
      });
      
      document.getElementById('export-btn')?.addEventListener('click', async () => {
        const btn = document.getElementById('export-btn') as HTMLButtonElement;
        btn.disabled = true;
        btn.innerHTML = 'Exportando...';
        
        try {
          await api.exportAuditLogs();
          showToast('Exportación exitosa', 'success');
        } catch (err: any) {
          showToast(err.message || 'Error al exportar', 'error');
        } finally {
          btn.disabled = false;
          btn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
            Exportar CSV
          `;
        }
      });
      
      document.getElementById('search-input')?.addEventListener('input', applyFilters);
      document.getElementById('action-filter')?.addEventListener('change', applyFilters);
      document.getElementById('date-filter')?.addEventListener('change', applyFilters);
      
    } catch (err: any) {
      console.error('Init error:', err);
      
      if (err.status === 401) {
        window.location.href = '/login/';
        return;
      }
      
      loadingState?.classList.add('hidden');
      errorState?.classList.remove('hidden');
      errorState?.classList.add('flex');
      document.getElementById('error-message')!.textContent = err.message || 'Error al cargar la auditoría';
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>
